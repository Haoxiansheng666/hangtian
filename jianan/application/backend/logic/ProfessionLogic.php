<?phpnamespace app\backend\logic;use app\backend\model\OccuProfession;use think\Db;use think\Request;class ProfessionLogic{       /**     * 客户查询的逻辑     * @access public     * @param array   $param 条件数据     * @param array   $ausess 账号的session信息     * @since dxf     * @return [array]     */	static public  function selectParam($param,$ausess){        $where=[];        //客户名称        if(isset($param['name']) && !empty($param['name'])){            $where['name']=array('like',"%$param[name]%");        }        //类别id        if(isset($param['cate_id']) && !empty($param['cate_id'])){            $where['cate_id']=$param['cate_id'];        }        //来源        if(isset($param['from']) && !empty($param['from'])){            $where['from']=$param['from'];        }        //添加人        if(isset($param['auid']) && !empty($param['auid'])){            $where['auid']=$param['auid'];        }        //跟进状态        if(isset($param['follow_status']) && !empty($param['follow_status'])){            $where['follow_status']=$param['follow_status'];        }        // 下次跟进开始时间        if(isset($param['action_time']) && !empty($param['action_time'])){            $where['next_contact_time'] = ['>=' , strtotime($param['action_time'])];        }        // 下次跟进结束时间        if(isset($param['end_time']) && !empty($param['end_time'])){            if (!empty($where['next_contact_time'])){                $where['next_contact_time'] = ['between' , [strtotime($param['action_time']),strtotime($param['end_time'])]];            }else{                $where['next_contact_time'] = ['between' , [1,strtotime($param['end_time'])]];            }        }        return $where;    }    static public  function select_Param($param,$ausess){        $where=[];        //客户名称        if(isset($param['name']) && !empty($param['name'])){            $where['name']=array('like',"%$param[name]%");        }        return $where;    }    /**     * 客户数据下载的逻辑     * @access public     * @param array   $data 要下载的数据     * @param array   $name excel表名称     * @since dxf     * @return [file]     */    static public function down($data,$name,$title = ''){        vendor('PHPExcel.PHPExcel');        $objPHPExcel = new \PHPExcel();        $objPHPExcel->getActiveSheet()->getStyle('A:B')->getAlignment()->setHorizontal(\PHPExcel_Style_Alignment::HORIZONTAL_CENTER);        //遍历数组，注意数组对应的下标        if($name=='职业提升工种导入模板'){            foreach($data as $k => $v){                //合并单元格                $objPHPExcel->setActiveSheetIndex(0)->mergeCells('A1:B2');                $objPHPExcel->setActiveSheetIndex(0)->setCellValue('A1', $title);                //设置单元格里面的值对齐                $objPHPExcel->getActiveSheet()->getStyle('A1')->getAlignment()->setWrapText(true);                $objPHPExcel->setActiveSheetIndex(0)                    ->setCellValue('A'.$k, $v['profession_top'])                    ->setCellValue('B'.$k, $v['profession']);            }        }else{            foreach($data as $k => $v){                //合并单元格                $objPHPExcel->setActiveSheetIndex(0)->mergeCells('A1:B2');                $objPHPExcel->setActiveSheetIndex(0)->setCellValue('A1', $title);                //设置单元格里面的值对齐                $objPHPExcel->getActiveSheet()->getStyle('A1')->getAlignment()->setWrapText(true);                $objPHPExcel->setActiveSheetIndex(0)                    ->setCellValue('A'.$k, $v['profession_top'])                    ->setCellValue('B'.$k, $v['profession']);            }        }        ob_end_clean();        header('Content-Type: application/vnd.ms-excel');        header('Content-Disposition: attachment;filename="'.$name.'.xls"');        header('Cache-Control: max-age=0');        $objWriter = \PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel2007');        $objWriter->save('php://output');        exit;    }    /**     * 模板下载的表头     * @access public      * @since dxf      * @return [array]     */    static public function muban(){        $rs['3']['profession_top'] = '工种';$rs['3']['profession'] = '可培训级别';        $rs['4']['profession_top'] = '电工';$rs['4']['profession'] = '五';        $rs['5']['profession_top'] = '电工';$rs['5']['profession'] = '四';        $rs['6']['profession_top'] = '电工';$rs['6']['profession'] = '三';        $rs['7']['profession_top'] = '焊工';$rs['7']['profession'] = '五';        $rs['8']['profession_top'] = '焊工';$rs['8']['profession'] = '四';        $rs['9']['profession_top'] = '焊工';$rs['9']['profession'] = '三';        return $rs;    }    /**     * 文件上传的字段逻辑     * @access public     * @param file   $uploadfile 上传后的文件名     * @param array   $ausess 用户数据     * @since dxf     * @return [array]     */    static public function uploadFile($uploadfile,$ausess)    {        vendor('PHPExcel.PHPExcel');        vendor('PHPExcel.PHPExcel.IOFactory');        vendor('PHPExcel.PHPExcel.Reader.Excel2007.php');        vendor('PHPExcel.PHPExcel.Reader.Excel5.php');        vendor('PHPExcel.PHPExcel.Reader.CSV.php');        $extension = strtolower(pathinfo($uploadfile, PATHINFO_EXTENSION) );        if ($extension =='xlsx') {            $objReader = new \PHPExcel_Reader_Excel2007();            $objPHPExcel = $objReader ->load($uploadfile);        } else if ($extension =='xls') {            $objReader = new \PHPExcel_Reader_Excel5();            $objPHPExcel = $objReader ->load($uploadfile);        } else if ($extension=='csv') {            $PHPReader = new \PHPExcel_Reader_CSV();            //默认输入字符集            $PHPReader->setInputEncoding('UTF-8');            //默认的分隔符            $PHPReader->setDelimiter(',');            //载入文件            $objPHPExcel = $PHPReader->load($uploadfile);        }        $sheet = $objPHPExcel->getSheet(0);        $highestRow = $sheet->getHighestRow();           //取得总行数        $highestColumn = $sheet->getHighestColumn();    //取得总列数        $objWorksheet = $objPHPExcel->getActiveSheet();        $highestRow = $objWorksheet->getHighestRow();        //echo '总行数='.$highestRow;        $highestColumn = $objWorksheet->getHighestColumn();        $highestColumnIndex = \PHPExcel_Cell::columnIndexFromString($highestColumn);        $headtitle=array();        $msg=array();        $status=1;        for ($row = 3;$row <= $highestRow;$row++)        {            $strs=array();            //注意highestColumnIndex的列数索引从0开始            for ($col = 0;$col < $highestColumnIndex;$col++)            {                $strs[$col] =$objWorksheet->getCellByColumnAndRow($col, $row)->getValue();            }            //检查表头            if($row==3){                if(trim($strs['0']) != '工种'){                    $msg="表头:".$strs['0']."，与要求表头不匹配";                    $status=-1;                    break;                }                if(trim($strs['1']) != '可培训级别'){                    $msg="表头:".$strs['0']."，与要求表头不匹配";                    $status=-1;                    break;                }            }elseif($row>1001){                $msg='导入失败！单次最大导入量1000条';                $status=-1;                break;            }else{                $pro_id = OccuProfession::where('name',trim($strs['0']))->value('id');                $data['name'] = $pro_id ? trim($strs['1']) : trim($strs['0']);                $data['create_time']=time();                $data['pid'] = $pro_id ? $pro_id : 0;                if(!OccuProfession::where(['pid'=>$data['pid'],'name'=>$data['name']])->find()){                    if($data['pid'] == 0){                        $model = new OccuProfession();                        $model->save($data);                        $pid = $model->id;                        $data1['name'] = trim($strs['1']);                        $data1['create_time']=time();                        $data1['pid'] = $pid;                        (new OccuProfession())->save($data1);                    }else{                        (new OccuProfession())->save($data);                    }                }            }        }        if($status==1){            return ['status'=>1,'msg'=>'数据检查成功','data'=>$data];        }else{            return ['status'=>-1,'msg'=>$msg];        }    }} 