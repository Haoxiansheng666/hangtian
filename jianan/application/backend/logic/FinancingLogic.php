<?phpnamespace app\backend\logic;use app\backend\model\CompanyCustomerBatch;use app\backend\model\Customer;use app\backend\model\PayStudent;use app\backend\model\Profession;use Exception;use think\Db;use think\Request;class FinancingLogic{    /**     * 客户查询的逻辑     * @access public     * @param array $param 条件数据     * @param array|void|mixed $ausess 账号的session信息     * @return array     */    public static function selectParam($param,$ausess){        $where=[];        //添加人        if(isset($param['auid']) && !empty($param['auid'])){            $customer_ids = (new Customer())                ->where('auid',$param['auid'])                ->column('id');            $where['customer_id']=['in',$customer_ids];        }        // 客户ID        if (!empty($param['company_name'])){            $where['customer_id'] = $param['company_name'];        }        // 支付状态        if (!empty($param['pay_status'])){            $where['pay_status'] = $param['pay_status'];        }        return $where;    }    /**     * 获取个人客户的财务统计查询条件     * @param $param     * @param $ausess     * @return array     */    public static function selectGrParam($param,$ausess){        $where = [];        //客户名称        if (isset($param['name']) && !empty($param['name'])) {            $where['name'] = array('like', "%".$param['name']."%");        }        //手机号        if (isset($param['mobile']) && !empty($param['mobile'])) {            $where['mobile'] = array('like', "%".$param['mobile']."%");        }        //添加人        if (isset($param['auid']) && !empty($param['auid'])) {            $where['auid'] = $param['auid'];        }        //学员状态        if (!empty($param['status'])) {            $where['status'] = $param['status'];        }        //工种        if (!empty($param['profession_id'])) {            $where['profession_id'] = $param['profession_id'];        } // 一级栏目        elseif (!empty($param['pid'])) {            $profession_ids = (new Profession())                ->where([                    'pid' => $param['pid']                ])                ->column('id');            $where['profession_id'] = ['in', $profession_ids];        } // 工种类型        elseif (!empty($param['cate_id'])) {            $profession_ids = (new Profession())                ->where([                    'cate_id' => $param['cate_id'],                    'pid' => 0                ])                ->column('id');            $where['profession_id'] = ['in', $profession_ids];        }        return $where;    }    /**     * 财务审核查询条件     * @param $param     * @param $ausess     * @return array     */    public static function selectAuditParam($param,$ausess){        $where=[];        //客户名称        if(isset($param['name']) && !empty($param['name'])){            $customer_where['name']=array('like',"%$param[name]%");        }        //手机号        if(isset($param['mobile']) && !empty($param['mobile'])){            $customer_where['mobile']=array('like',"%$param[mobile]%");        }        //添加人        if(isset($param['auid']) && !empty($param['auid'])){            $customer_where['auid']=$param['auid'];        }        //企业        if(isset($param['company_id']) && !empty($param['company_id'])){            $customer_where['company_id'] = $param['company_id'];        }        // 企业用户与个人用户区别查询        if (!empty($customer_where)){            $pay_student_ids = (new PayStudent())                ->where($customer_where)                ->column('id');            $where['pay_student_id'] = ['in',$pay_student_ids];        }        // 创建时间        if(isset($param['action_time']) && !empty($param['action_time'])){            $where['create_time'] = ['>=' , strtotime($param['action_time'])];        }        // 创建时间截止查询时间        if(isset($param['end_time']) && !empty($param['end_time'])){            if (!empty($where['create_time'])){                $where['create_time'] = ['between' , [strtotime($param['action_time']),strtotime($param['end_time'])]];            }else{                $where['create_time'] = ['<=' , strtotime($param['end_time'])];            }        }        if (isset($param['status']) && $param['status'] != ''){            $where['status'] = $param['status'];        }        return $where;    }    /**     * 客户数据下载的逻辑     * @access public     * @param array $data 要下载的数据     * @param array|string|void|mixed $name excel表名称     * @param int $ware_id 客户、个人财务统计判断     * @return void     * @throws Exception     */    static public function down($data,$name,$ware_id = 0){        vendor('PHPExcel.PHPExcel');        $objPHPExcel = new \PHPExcel();        $objPHPExcel->getActiveSheet()->getStyle('A:N')->getAlignment()->setHorizontal(\PHPExcel_Style_Alignment::HORIZONTAL_CENTER);        //遍历数组，注意数组对应的下标        if($name=='客户财务信息导出'){            foreach($data as $k => $v){                $k=1;                $objPHPExcel->setActiveSheetIndex(0)                    ->setCellValue('A'.$k, $v['id'])                    ->setCellValue('B'.$k, $v['from_name'])                    ->setCellValue('C'.$k, $v['cate_name'])                    ->setCellValue('D'.$k, $v['name'])                    ->setCellValue('E'.$k, ' '.$v['id_card'])                    ->setCellValue('F'.$k, $v['address'])                    ->setCellValue('G'.$k, $v['create_time'])                    ->setCellValue('H'.$k, $v['real_name']);            }        }else{            if ($ware_id == 1){                foreach($data as $k => $v){                    $k++;                    $objPHPExcel->setActiveSheetIndex(0)                        ->setCellValue('A'.$k, $v['id'])                        ->setCellValue('B'.$k, $v['batch_number'])                        ->setCellValue('C'.$k, $v['company_name'])                        ->setCellValue('D'.$k, $v['name'])                        ->setCellValue('E'.$k, ' '.$v['mobile'])                        ->setCellValue('F'.$k, $v['total_price'])                        ->setCellValue('G'.$k, $v['pay_price'])                        ->setCellValue('H'.$k, $v['surplus_price'])                        ->setCellValue('I'.$k, $v['admin'])                        ->setCellValue('J'.$k, $v['pay_status'])                        ->setCellValue('K'.$k, $v['apply_num'])                        ->setCellValue('L'.$k, $v['create_time']);                }            }else{                $objPHPExcel->setActiveSheetIndex(0)                    ->setCellValue('A1', '客户名称')                    ->setCellValue('B1', '身份证号')                    ->setCellValue('C1', '业务员')                    ->setCellValue('D1', '应缴金额')                    ->setCellValue('E1', '实缴金额')                    ->setCellValue('F1', '工种')                    ->setCellValue('G1', '类型')                    ->setCellValue('H1', '审核状态')                    ->setCellValue('I1', '提交时间');                foreach($data as $k=>$v){                    $k++;                    $objPHPExcel->setActiveSheetIndex(0)                        ->setCellValue('A'.($k+1), $v['pay_student']['name'] ?? $v['customer']['name'])                        ->setCellValue('B'.($k+1), ' '.$v['pay_student']['id_card'])                        ->setCellValue('C'.($k+1), $v['pay_student']['admin']['real_name'] ?? $v['customer']['admin']['real_name'])                        ->setCellValue('D'.($k+1), $v['pay_student']['total_price'])                        ->setCellValue('E'.($k+1), $v['pay_price'])                        ->setCellValue('F'.($k+1), $v['profession_top'])                        ->setCellValue('G'.($k+1), $v['profession'])                        ->setCellValue('H'.($k+1), $v['status'] == 0 ? "未审核" : ($v['status'] == 1 ? "审核通过" : "审核拒绝"))                        ->setCellValue('I'.($k+1), $v['create_time']);                }            }        }        ob_end_clean();        header('Content-Type: application/vnd.ms-excel');        header('Content-Disposition: attachment;filename="'.$name.'.xls"');        header('Cache-Control: max-age=0');        $objWriter = \PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel2007');        $objWriter->save('php://output');        exit;    }    /**     * 客户数据下载的逻辑     * @access public     * @param array $data 要下载的数据     * @param array|string|void|mixed $name excel表名称     * @return void     * @throws Exception     */    static public function gra_down($data,$name){        vendor('PHPExcel.PHPExcel');        $objPHPExcel = new \PHPExcel();        $objPHPExcel->getActiveSheet()->getStyle('A:N')->getAlignment()->setHorizontal(\PHPExcel_Style_Alignment::HORIZONTAL_CENTER);        $objPHPExcel->setActiveSheetIndex(0)            ->setCellValue('A1', '班级名称')            ->setCellValue('B1', '班主任')            ->setCellValue('C1', '班主任电话')            ->setCellValue('D1', '班级类型')            ->setCellValue('E1', '工种')            ->setCellValue('F1', '类型')            ->setCellValue('G1', '业务员')            ->setCellValue('H1', '状态')            ->setCellValue('I1', '培训开始时间')            ->setCellValue('J1', '培训结束时间')            ->setCellValue('K1', '提交时间');        foreach($data as $k=>$v){            $k++;            $objPHPExcel->setActiveSheetIndex(0)                ->setCellValue('A'.($k+1), $v['name'])                ->setCellValue('B'.($k+1), $v['teacher'])                ->setCellValue('C'.($k+1), ' '.$v['mobile'])                ->setCellValue('D'.($k+1), $v['train_site'] == 1 ? "线上班级" : ($v['train_site'] == 2 ? "线下班级" : "线上线下班级"))                ->setCellValue('E'.($k+1), $v['profession_top'])                ->setCellValue('F'.($k+1), $v['profession'])                ->setCellValue('G'.($k+1), $v['admin'])                ->setCellValue('H'.($k+1), $v['status'] == 0 ?  "未开课" : ($v['status'] == 1 ? "已开课" : "已结束"))                ->setCellValue('I'.($k+1), date('Y-m-d H:i',$v['train_action_time']))                ->setCellValue('J'.($k+1), date('Y-m-d H:i',$v['train_end_time']))                ->setCellValue('K'.($k+1), $v['create_time']);        }        ob_end_clean();        header('Content-Type: application/vnd.ms-excel');        header('Content-Disposition: attachment;filename="'.$name.'.xls"');        header('Cache-Control: max-age=0');        $objWriter = \PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel2007');        $objWriter->save('php://output');        exit;    }    /**     * 客户数据下载的逻辑     * @access public     * @param array $data 要下载的数据     * @param array|string|void|mixed $name excel表名称     * @return void     * @throws Exception     */    static public function stu_down($data,$name){        vendor('PHPExcel.PHPExcel');        $objPHPExcel = new \PHPExcel();        $objPHPExcel->getActiveSheet()->getStyle('A:N')->getAlignment()->setHorizontal(\PHPExcel_Style_Alignment::HORIZONTAL_CENTER);        $objPHPExcel->setActiveSheetIndex(0)            ->setCellValue('A1', '学员名字')            ->setCellValue('B1', '手机号')            ->setCellValue('C1', '班级')            ->setCellValue('D1', '教师')            ->setCellValue('E1', '工种')            ->setCellValue('F1', '类型')            ->setCellValue('G1', '业务员')            ->setCellValue('H1', '工作单位')            ->setCellValue('I1', '状态')            ->setCellValue('J1', '提交时间');        foreach($data as $k=>$v){            $k++;            $objPHPExcel->setActiveSheetIndex(0)                ->setCellValue('A'.($k+1), $v['pay_student'])                ->setCellValue('B'.($k+1), ' '.$v['mobile'])                ->setCellValue('C'.($k+1), $v['grade'])                ->setCellValue('D'.($k+1), $v['teacher'])                ->setCellValue('E'.($k+1), $v['profession_top']['name'])                ->setCellValue('F'.($k+1), $v['profession']['name'])                ->setCellValue('G'.($k+1), $v['admin'])                ->setCellValue('H'.($k+1), $v['company'])                ->setCellValue('I'.($k+1), $v['status'] == 0 ? "培训中" : ($v['status'] == 1 ? "培训完成" : ($v['status'] == 2 ? "待培训" : "异常")))                ->setCellValue('J'.($k+1), $v['create_time']);        }        ob_end_clean();        header('Content-Type: application/vnd.ms-excel');        header('Content-Disposition: attachment;filename="'.$name.'.xls"');        header('Cache-Control: max-age=0');        $objWriter = \PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel2007');        $objWriter->save('php://output');        exit;    }    /**     * 客户数据下载的逻辑     * @access public     * @param array $data 要下载的数据     * @param array|string|void|mixed $name excel表名称     * @return void     * @throws Exception     */    static public function exam_down($data,$name){        vendor('PHPExcel.PHPExcel');        $objPHPExcel = new \PHPExcel();        $objPHPExcel->getActiveSheet()->getStyle('A:N')->getAlignment()->setHorizontal(\PHPExcel_Style_Alignment::HORIZONTAL_CENTER);        $objPHPExcel->setActiveSheetIndex(0)            ->setCellValue('A1', '考试名称')            ->setCellValue('B1', '班主任')            ->setCellValue('C1', '班主任电话')            ->setCellValue('D1', '工种')            ->setCellValue('E1', '类型')            ->setCellValue('F1', '业务员')            ->setCellValue('G1', '状态')            ->setCellValue('H1', '考试时间')            ->setCellValue('I1', '提交时间');        foreach($data as $k=>$v){            $k++;            $objPHPExcel->setActiveSheetIndex(0)                ->setCellValue('A'.($k+1), $v['name'])                ->setCellValue('B'.($k+1), $v['teacher'])                ->setCellValue('C'.($k+1), ' '.$v['mobile'])                ->setCellValue('D'.($k+1), $v['profession_top'])                ->setCellValue('E'.($k+1), $v['profession'])                ->setCellValue('F'.($k+1), $v['admin'])                ->setCellValue('G'.($k+1), $v['status'] == 0 ?  "未开始" : ($v['status'] == 1 ? "考试中" : "已结束"))                ->setCellValue('H'.($k+1), date('Y-m-d H:i',$v['exam_time']))                ->setCellValue('I'.($k+1), $v['create_time']);        }        ob_end_clean();        header('Content-Type: application/vnd.ms-excel');        header('Content-Disposition: attachment;filename="'.$name.'.xls"');        header('Cache-Control: max-age=0');        $objWriter = \PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel2007');        $objWriter->save('php://output');        exit;    }    /**     * 客户数据下载的逻辑     * @access public     * @param array $data 要下载的数据     * @param array|string|void|mixed $name excel表名称     * @return void     * @throws Exception     */    static public function exam_stu($data,$name){        vendor('PHPExcel.PHPExcel');        $objPHPExcel = new \PHPExcel();        $objPHPExcel->getActiveSheet()->getStyle('A:N')->getAlignment()->setHorizontal(\PHPExcel_Style_Alignment::HORIZONTAL_CENTER);        $objPHPExcel->setActiveSheetIndex(0)            ->setCellValue('A1', '学员名字')            ->setCellValue('B1', '手机号')            ->setCellValue('C1', '考试')            ->setCellValue('D1', '教师')            ->setCellValue('E1', '工种')            ->setCellValue('F1', '类型')            ->setCellValue('G1', '业务员')            ->setCellValue('H1', '工作单位')            ->setCellValue('I1', '状态')            ->setCellValue('J1', '提交时间');        foreach($data as $k=>$v){            $k++;            $objPHPExcel->setActiveSheetIndex(0)                ->setCellValue('A'.($k+1), $v['pay_student'])                ->setCellValue('B'.($k+1), ' '.$v['mobile'])                ->setCellValue('C'.($k+1), $v['grade'])                ->setCellValue('D'.($k+1), $v['teacher'])                ->setCellValue('E'.($k+1), $v['profession_top']['name'])                ->setCellValue('F'.($k+1), $v['profession']['name'])                ->setCellValue('G'.($k+1), $v['admin'])                ->setCellValue('H'.($k+1), $v['company'])                ->setCellValue('I'.($k+1), $v['status'] == 0 ? "培训中" : ($v['status'] == 1 ? "培训完成" : ($v['status'] == 2 ? "待培训" : "异常")))                ->setCellValue('J'.($k+1), $v['create_time']);        }        ob_end_clean();        header('Content-Type: application/vnd.ms-excel');        header('Content-Disposition: attachment;filename="'.$name.'.xls"');        header('Cache-Control: max-age=0');        $objWriter = \PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel2007');        $objWriter->save('php://output');        exit;    }    /**     * @param $data     * @param $name     * @throws Exception     */    static public function com_down($data,$name){        vendor('PHPExcel.PHPExcel');        $objPHPExcel = new \PHPExcel();        $objPHPExcel->getActiveSheet()->getStyle('A:N')->getAlignment()->setHorizontal(\PHPExcel_Style_Alignment::HORIZONTAL_CENTER);        $objPHPExcel->setActiveSheetIndex(0)            ->setCellValue('A1', '批次号')            ->setCellValue('B1', '企业名称')            ->setCellValue('C1', '联系人')            ->setCellValue('D1', '手机号')            ->setCellValue('E1', '应缴金额')            ->setCellValue('F1', '实缴金额')            ->setCellValue('G1', '余额')            ->setCellValue('H1', '业务员');        foreach($data as $k=>$v){            $k++;            $objPHPExcel->setActiveSheetIndex(0)                ->setCellValue('A'.($k+1), $v['batch_number'])                ->setCellValue('B'.($k+1), $v['company'])                ->setCellValue('C'.($k+1), $v['contact'])                ->setCellValue('D'.($k+1), ' '.$v['mobile'])                ->setCellValue('E'.($k+1), $v['total_price'])                ->setCellValue('F'.($k+1), $v['pay_price'])                ->setCellValue('G'.($k+1), $v['price'])                ->setCellValue('H'.($k+1), $v['admin']);        }        ob_end_clean();        header('Content-Type: application/vnd.ms-excel');        header('Content-Disposition: attachment;filename="'.$name.'.xls"');        header('Cache-Control: max-age=0');        $objWriter = \PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel2007');        $objWriter->save('php://output');        exit;    }    /**     * @param $data     * @param $name     * @throws Exception     */    static public function qiye_down($data,$name){        vendor('PHPExcel.PHPExcel');        $objPHPExcel = new \PHPExcel();        $objPHPExcel->getActiveSheet()->getStyle('A:N')->getAlignment()->setHorizontal(\PHPExcel_Style_Alignment::HORIZONTAL_CENTER);        $objPHPExcel->setActiveSheetIndex(0)            ->setCellValue('A1', '客户名称')            ->setCellValue('B1', '身份证号')            ->setCellValue('C1', '业务员')            ->setCellValue('D1', '企业名称')            ->setCellValue('E1', '应缴金额')            ->setCellValue('F1', '实缴金额')            ->setCellValue('G1', '审核状态')            ->setCellValue('H1', '审核时间')            ->setCellValue('I1', '审核人员');        foreach($data as $k=>$v){            $k++;            $objPHPExcel->setActiveSheetIndex(0)                ->setCellValue('A'.($k+1), $v['name'])                ->setCellValue('B'.($k+1), ' '.$v['id_card'])                ->setCellValue('C'.($k+1), $v['admin'])                ->setCellValue('D'.($k+1), $v['company'])                ->setCellValue('E'.($k+1), $v['total_price'])                ->setCellValue('F'.($k+1), $v['pay_price'])                ->setCellValue('G'.($k+1), $v['status'] == 0 ? "未审核" : ($v['status'] == 1 ? "审核通过" : "审核未通过"))                ->setCellValue('H'.($k+1), $v['operate_time'])                ->setCellValue('I'.($k+1), $v['operate']);        }        ob_end_clean();        header('Content-Type: application/vnd.ms-excel');        header('Content-Disposition: attachment;filename="'.$name.'.xls"');        header('Cache-Control: max-age=0');        $objWriter = \PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel2007');        $objWriter->save('php://output');        exit;    }} 